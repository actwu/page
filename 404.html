<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Page It — Publisher, write → preview → deploy your HTML directly to GitHub Pages">
<title>Page It — Publisher</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
html,body{margin:0;padding:0;background:#000;color:#fff;font-family:"Roboto Mono",monospace;height:100%;overflow:hidden}
main{display:flex;flex-direction:column;height:100%}
section[aria-stage]{flex:1;display:none;padding:1rem;box-sizing:border-box}
section[aria-stage][data-active]{display:flex;flex-direction:row;gap:0rem;align-items:stretch}
textarea{flex:1;background:#111;color:#fff;border:1px solid #333;resize:none;padding:.5rem;font-size:.9rem;outline:none;height:100%}
iframe{flex:1;background:#fff;border:1px solid #333;height:100%}
form{display:flex;flex-direction:column;gap:.5rem;max-width:300px}
input,button{background:#111;color:#fff;border:1px solid #333;padding:.4rem;font-size:.9rem}
button:hover{background:#222;cursor:pointer}
nav{position:fixed;bottom:0;left:0;background:#111;padding:.5rem;display:flex;gap:.5rem;border-top:1px solid #333}
@media (orientation: landscape) {
 section[aria-stage][data-active]{flex-direction:column-reverse}
}
</style>
</head>
<body>
<main>
<section aria-stage="1" data-active>
<textarea id="editor" placeholder="Write HTML here..."></textarea>
<iframe id="preview" aria-label="Live preview"></iframe>
</section>

<section aria-stage="2">
<form id="publishForm">
<label>GitHub Token <input id="token" type="password" required></label>
<label>Repo Name <input id="repo" required></label>
<button id="publishBtn" type="button">Publish</button>
</form>
</section>

<section aria-stage="3">
<div id="sitesList"></div>
</section>
</main>

<nav>
<button id="prevBtn">← Back</button>
<button id="nextBtn">Next →</button>
</nav>

<script defer>
let stage=1
const stages=document.querySelectorAll('section[aria-stage]')
const editor=document.getElementById('editor')
const frame=document.getElementById('preview')
const token=document.getElementById('token')
const repo=document.getElementById('repo')
const list=document.getElementById('sitesList')
const prevBtn=document.getElementById('prevBtn')
const nextBtn=document.getElementById('nextBtn')
const publishBtn=document.getElementById('publishBtn')

let timer
const updatePreview=_0=>{
 clearTimeout(timer)
 timer=setTimeout(()=>{
  const doc=frame.contentDocument
  doc.open()
  doc.write(editor.value)
  doc.close()
  localStorage.setItem('pageit_html',editor.value)
 },120)
}

const switchStage=_0=>{
 stages.forEach(s=>s.removeAttribute('data-active'))
 stages[stage-1].setAttribute('data-active','')
}

const restoreState=_0=>{
 editor.value=localStorage.getItem('pageit_html')||''
 token.value=localStorage.getItem('pageit_token')||''
 repo.value=localStorage.getItem('pageit_repo')||''
 renderSites()
 updatePreview()
}

const saveForm=_0=>{
 localStorage.setItem('pageit_token',token.value)
 localStorage.setItem('pageit_repo',repo.value)
}

const renderSites=_0=>{
 const saved=JSON.parse(localStorage.getItem('pageit_sites')||'[]')
 list.innerHTML=saved.length?'<h3>Published Sites</h3>':'' 
 saved.forEach(u=>{
  const a=document.createElement('a')
  a.href=u
  a.textContent=u
  a.target='_blank'
  a.style.display='block'
  list.appendChild(a)
 })
}

const publish=_0=>{
 saveForm()
 fetch('https://api.github.com/user',{headers:{Authorization:'token '+token.value}})
 .then(r=>r.json())
 .then(user=>{
  if(!user.login){alert('Invalid token');return}
  const repoName=repo.value.trim()
  fetch('https://api.github.com/user/repos',{
   method:'POST',
   headers:{Authorization:'token '+token.value,'Content-Type':'application/json'},
   body:JSON.stringify({name:repoName,private:false})
  })
  .then(r=>r.json())
  .then(()=>{
   const html=btoa(unescape(encodeURIComponent(editor.value)))
   const index=btoa('<meta http-equiv="refresh" content="0;url=404.html">')
   const put=(p,c)=>fetch(`https://api.github.com/repos/${user.login}/${repoName}/contents/${p}`,{
    method:'PUT',
    headers:{Authorization:'token '+token.value,'Content-Type':'application/json'},
    body:JSON.stringify({message:'init',content:c})
   })
   put('404.html',html)
   .then(()=>put('index.html',index))
   .then(()=>{
    fetch(`https://api.github.com/repos/${user.login}/${repoName}/pages`,{
     method:'POST',headers:{Authorization:'token '+token.value}
    }).then(()=>{
     const url=`https://${user.login}.github.io/${repoName}`
     const arr=JSON.parse(localStorage.getItem('pageit_sites')||'[]')
     arr.push(url)
     localStorage.setItem('pageit_sites',JSON.stringify(arr))
     alert('Published at '+url)
     renderSites()
     stage=3
     switchStage()
    })
   })
  }).catch(e=>alert('Error: '+e))
 })
}

editor.addEventListener('input',updatePreview)
publishBtn.addEventListener('click',publish)
prevBtn.addEventListener('click',_0=>{if(stage>1){stage--;switchStage()}})
nextBtn.addEventListener('click',_0=>{if(stage<3){stage++;switchStage()}})
window.addEventListener('load',restoreState)
</script>
</body>
</html>

